<%function monetarizar(valor){
  if (valor < 1) {
      return "-";
  }
  valor = new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" }).format(valor);
  return valor;
}%>

<h2>Cierre de Caja <span class="btn btnHeader" id="abrirCaja">Abrir</span></h2>

<%if(registros.length == 0){%>
    <span>No se encuentran registros en la base de datos</span>
<%} else {%>
    <table>
        <thead>
            <tr>
                <th>Numero</th>
                <th>Fecha</th>
                <th>Apertura</th>
                <th>Cierre</th>
                <th>Detalles</th>
            </tr>
        </thead>
        <tbody>
            <%registros.forEach((registro) => {
                const apertura = JSON.parse(registro.inicio);
                const cierre = JSON.parse(registro.cierre);
                const fechaApertura = new Date(apertura.fecha)%>
            <tr>
                <td><%=registro.numero%></td>
                <td><%=registro.fecha%></td>
                <td>
                    <span class="cierreCajaInfo">info
                        <span class="cierreCajaObservaciones">
                            <span>
                                <span>Hora: </span>
                                <span><%= fechaApertura.toLocaleTimeString() %></span>
                            </span><hr>
                            <span>
                                <span>Responsale: </span>
                                <span><%= apertura.nombre %></span>
                            </span><hr>
                            <span>
                                <span>Efectivo: </span>
                                <span><%= monetarizar(apertura.efectivo) %></span>
                            </span><hr>
                            <span>
                                <span>Reservado: </span>
                                <span><%= monetarizar(apertura.reservado) %></span>
                            </span>
                        </span>
                    </span>
                </td>
                <td>
                  <%if(cierre === null){%>
                    <span class="btn btnVerde cierreCajaCerrar" data-id="<%=registro.id%>">Cerrar</span>
                  <%} else {
                    const fechaCierre = new Date(cierre.fecha)%>

                    <span class="cierreCajaInfo">info
                        <span class="cierreCajaObservaciones">
                            <span>
                                <span>Hora: </span>
                                <span><%= fechaCierre.toLocaleTimeString() %></span>
                            </span><hr>
                            <span>
                                <span>Responsale: </span>
                                <span><%= cierre.nombre %></span>
                            </span><hr>
                            <span>
                                <span>Efectivo: </span>
                                <span><%= monetarizar(cierre.efectivo) %></span>
                            </span><hr>
                            <span>
                                <span>Reservado: </span>
                                <span><%= monetarizar(cierre.reservado) %></span>
                            </span>
                        </span>
                    </span>
                  <%}%>  
                </td>
                <td><span class="cierreCajaDetalles" data-id="<%=registro.id%>">Ver</span></td>
            </tr>
            <%})%>
        </tbody>
    </table>
<%}%>

<script>
    window.registros = <%- JSON.stringify(registros) %>
    window.gastos = <%- JSON.stringify(gastos) %>
    window.facturas = <%- JSON.stringify(facturas) %>
    window.resumen = <%- JSON.stringify(resumen) %>
    window.fecha = <%- JSON.stringify(fecha) %>
</script>

<script defer src="/script/cierreCaja.js"></script>