<%  function verFechaFiltro(fecha){
        let year = fecha.getFullYear();
        let month = fecha.getMonth() + 1;
        let day = fecha.getDate();
        return day + "/" + month + "/" + year;
    }
    let cEDiasDeEntrega = JSON.parse(dataLocal.entrega);
    let fechaHoy = new Date(2023, 10, 20);

    //buscar dia de proxima entrega
    let cEProximaEntrega;
    let cEDiasRestanteProxEntrega;
    let cEPlusSegundaFecha;
    let fechaEntregaActiva = 0;
    for(let i = 0; i < cEDiasDeEntrega.length; i++) {
        if(fechaHoy.getDay() <= cEDiasDeEntrega[i]){
            cEProximaEntrega = cEDiasDeEntrega[i];
            cEDiasRestanteProxEntrega = cEDiasDeEntrega[i] - fechaHoy.getDay();
            // cEPlusSegundaFecha = cEDiasDeEntrega[i+1] - cEDiasDeEntrega[i];
            if(i + 1 == cEDiasDeEntrega.length){
                cEPlusSegundaFecha = cEDiasDeEntrega[0] + 7 - cEDiasDeEntrega[i];
            } else {
                cEPlusSegundaFecha = cEDiasDeEntrega[i+1] - cEDiasDeEntrega[i];
            }
            break;
        }
    }
    if(cEProximaEntrega == undefined){
        cEProximaEntrega = cEDiasDeEntrega[0]
        cEDiasRestanteProxEntrega = cEDiasDeEntrega[0] + 7 - fechaHoy.getDay();
        cEPlusSegundaFecha = cEDiasDeEntrega[1] - cEDiasDeEntrega[0];
    }
    // console.log(cEPlusSegundaFecha)

    // Setear fecha de proxima entrega
    let cEFechaEntregaPedido = new Date(fechaHoy.getFullYear(), fechaHoy.getMonth(), fechaHoy.getDate() + cEDiasRestanteProxEntrega, 12);
    let cEFechaEntregaProxPedido = new Date(fechaHoy.getFullYear(), fechaHoy.getMonth(), fechaHoy.getDate() + cEDiasRestanteProxEntrega + cEPlusSegundaFecha, 12);
    // verifica cuanto falta para la proxima entrega (hrs) y determina si el pedido para la proxima fecha esta pendiente, abierto o cerrado
    let cEHorasRestanteEntregaPedido = (cEFechaEntregaPedido - fechaHoy) / 1000 / 60 / 60;
    let cEPedidoEstado;
    if(cEHorasRestanteEntregaPedido > 72){
        cEPedidoEstado = "pendiente";
    } else if(cEHorasRestanteEntregaPedido > 48) {
        cEPedidoEstado = "abierto";
        fechaEntregaActiva = verFechaFiltro(cEFechaEntregaPedido);
    } else {
        cEPedidoEstado = "cerrado";
    }
    // habilita estado para el pedido siguiente en base al analisis anterior
    let cEHorasRestanteEntregaProximoPedido = (cEFechaEntregaProxPedido - fechaHoy) / 1000 / 60 / 60;
    let cEProximoPedidoEstado = "pendiente";
    if(cEPedidoEstado == "cerrado"){
        if(cEHorasRestanteEntregaProximoPedido > 72){
            cEProximoPedidoEstado = "pendiente";
        } else if(cEHorasRestanteEntregaProximoPedido > 48) {
            cEProximoPedidoEstado = "abierto";
            fechaEntregaActiva = verFechaFiltro(cEFechaEntregaProxPedido);
        } else {
            cEProximoPedidoEstado = "cerrado";
        }
    }%>

<div class="titulo">
    <h2>Pedidos de Producción a Fábrica</h2>
</div>
<div id="calendarioPedidosProduccion" class="anchoMax">
    <h2>Calendario de Pedidos y Entregas</h2>
    <div id="calendarioPedidos">
        <div>
            <span>Hoy: </span>
            <span><%= fechaHoy.toLocaleString("es-AR") %></span>
        </div>
        <div>
            <span>Entrega: </span>
            <span><%= verFechaFiltro(cEFechaEntregaPedido) %></span>
            <span class="<%= cEPedidoEstado %>"> pedido <%= cEPedidoEstado %></span>
        </div>
        <div>
            <span>Proxima Entrega: </span>
            <span><%= verFechaFiltro(cEFechaEntregaProxPedido) %></span>
            <span class="<%= cEProximoPedidoEstado %>">pedido <%= cEProximoPedidoEstado %></span>
        </div>
    </div>
    <% if(cEPedidoEstado == "abierto" || cEProximoPedidoEstado == "abierto"){%>
    <div id="botones">
        <span class="btn btnNaranja">Nuevo Pedido</span>
    </div>
    <%} %>
</div>
<div class="produccionCont">
    <div class="produccion">
        <% data.forEach((pedido)=> {
            let estilo;
            switch (pedido.estado) {
                case "precarga":
                estilo = "pedidoProdPrecarga";
                imagen = "precarga";
                break;
                case "cargado":
                estilo = "pedidoProdCargado";
                imagen = "cargado";
                break;
                case "aceptado":
                estilo = "pedidoProdAceptado";
                imagen = "checked";
                break;
                case "produccion":
                estilo = "pedidoProdProduccion";
                imagen = "produccion";
                break;
                case "cerrado":
                estilo = "pedidoProdCerrado";
                imagen = "cerrado";
                break;
                default:
                break;
                }
            let buzon;
            if((pedido.buzon == "mensajeFabrica" && lector == "local") || (pedido.buzon == "mensajeLocal" && lector == "fabrica")){
                buzon = "block";
            } else {
                buzon = "none";
            } %>
            <div class="pedidosProdCard <%= estilo %>" data-id="<%= pedido.id %>" data-lector="<%= lector %>">
                <img src="/im/<%= imagen %>.svg" alt="icon" class="pedidosCardTipo">
                <img src="/im/mensaje.svg" alt="icon" class="pedidosCardMsj" style="display:<%=buzon%>">
                <span>Pedido: <%= pedido.id %></span>
                <span>Fecha: <%= pedido.fecha.toLocaleString("es-AR") %></span>
                <span><b>Estado: <%= pedido.estado %></b></span>
            </div>
            <% }) %>
    </div>
    <div class="produccionPedido">
        
        <% if(dataPedido !==undefined){%>
            <div class="pedidoCard">
                <h3>Pedido Nº<%= dataPedido.id %></h3>
                <hr>
                <h3>Fecha de Entrega: <%= verFechaFiltro(dataPedido.fecha) %></h3>
                <hr>
                <h3>Estado: <%= dataPedido.estado %></h3>
                <hr>
                <h3>Pedido:</h3>
                <div class="pedido">
                    <table id="tablaProduccionCard">
                        <thead>
                            <tr>
                                <th>Códgio</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Pecio Unitario</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% let detallePedido=JSON.parse(dataPedido.pedido);
                            detallePedido.forEach((item)=> {
                                let producto = productos.find((prod) => prod.id == item[1])
                                %>
                                <tr>
                                    <td><%= item[1] %></td>
                                    <td><%= producto.nombre %></td>
                                    <td><%= item[0] %></td>
                                    <td>$<%= item[2] %></td>
                                    <td>$<%= item[0] * item[2] %></td>
                                </tr>
                                <%})%>
                        </tbody>
                    </table>
                </div>
                <hr>
                <div>Total: <b>$<%= dataPedido.total %></b></div>
                <hr>
                <span>Estado: <%= dataPedido.estado %></span>

                <hr>
                <div class="pedidoEstado">
                    <span>Modificar estado:</span>
                    <% if(dataPedido.estado === "precargado" || dataPedido.estado === "cargado"){%>
                        <form id="formCancelado" method="post">
                            <input type="hidden" name="id" value="<%= dataPedido.id %>">
                            <input type="hidden" name="estado" value="cancelado">
                            <input type="submit" data-form="formCancelado" value="Cancelar" class="pedidoEstadoBoton btnRojo">
                        </form>
                    <%}%>
                    <% if(dataPedido.estado === "precargado"){%>
                            <form id="formEditar" method="post">
                                <input type="hidden" name="id" value="<%= dataPedido.id %>">
                                <input type="hidden" name="estado" value="editar">
                                <input type="submit" data-form="formEditar" value="Editar" class="pedidoEstadoBoton btnNaranja">
                            </form>
                            <form id="formEnviar" method="post">
                                <input type="hidden" name="id" value="<%= dataPedido.id %>">
                                <input type="hidden" name="estado" value="enviar">
                                <input type="submit" data-form="formEnviar" value="Enviar" class="pedidoEstadoBoton btnNaranja">
                            </form>
                    <%}%>
                    <% if(dataPedido.estado === "aceptado" || dataPedido.estado === "produccion"){%>
                        Actualmente no es posible modificar el estado del pedido, por cualquier modificación o consulta comunicarse con la fábrica, gracias
                    <%}%>
                </div>

            </div>

            <div class="chatMensajes">
                <% let mensajesPedido = JSON.parse(dataPedido.mensajes);
                mensajesPedido.forEach((mensaje) => {
                    let emisorMensaje;
                    if(mensaje[0] === "mensajeFabrica"){
                        emisorMensaje = "Fábrica";
                    } else {
                        emisorMensaje = "Local";
                    }%>
                    <div class="chatMensaje" id="<%= mensaje[0] %>">
                        <span>
                            <b><%= emisorMensaje %>:</b>
                            <%= mensaje[1] %>
                        </span>
                    </div>
                <%}) %>
            </div>

            <% let emisor = "mensajeLocal";
                if(lector == "fabrica"){emisor = "mensajeFabrica"};%>
            <form action="" id="chatProduccionSend" class="chatSend" method="post">
                <div class="inputError">&#10060; Ocurrió un error con el envío del mensaje, tener en cuenta el mismo no puede estar vacío ni contener caracteres especiales, recargue la página e intente nuevamente</div>
                <input type="hidden" name="emisorMensaje" value="<%= emisor %>" id="chatEmisor">
                <input type="hidden" name="pedidoProdNum" value="<%= dataPedido.id %>" id="pedidoProdNum">
                <input type="text" name="mensajeProduccion" class="chatInput" id="chatInput">
                <input type="submit" value="Enviar" class="chatBtnEnviar">
            </form>

            <%} %>
    </div>
</div>
<script>
    localStorage.setItem("fechaEntregaActiva", <%- JSON.stringify(fechaEntregaActiva) %>)
</script>