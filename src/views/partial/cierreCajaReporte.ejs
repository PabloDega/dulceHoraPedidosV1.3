<%function monetarizar(valor){
    if (valor == 0) {
        return "-";
    }
    valor = new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" }).format(valor);
    return valor;
  }

let apertura = JSON.parse(registro.inicio);
let cierre = JSON.parse(registro.cierre);
let reporte = JSON.parse(registro.reporte);
%>


<div id="cierreCajaReporteContenedor">
<div>
    <h1>Reporte de caja Nº<%=registro.numero%></h1>
    <div>
        <span>Fecha de Apertura:</span>
        <span><%= new Date(apertura.fecha).toLocaleString() %></span>
    </div>
    <div>
        <span>Fecha de Cierre:</span>
        <span><%= new Date(cierre.fecha).toLocaleString() %></span>
    </div>
    <hr>
    <h2>Información General</h2>
    <div>
        <span>Razon Social:</span>
        <span><%=local.nombre%></span>
    </div>
    <div>
        <span>Efectivo en apertura:</span>
        <span><%=monetarizar(apertura.efectivo + apertura.reservado)%></span>
    </div>
    <div>
        <span>Efectivo en Cierre:</span>
        <span><%=monetarizar((cierre.efectivo + cierre.reservado))%></span>
    </div>
    <div>
        <span>Diferencia:</span>
        <span><%=monetarizar((cierre.efectivo + cierre.reservado) - (apertura.efectivo + apertura.reservado))%></span>
    </div>
    <hr>
    <h2>Detalles</h2>
    <div>
        <span>Cantidad de Comandas:</span>
        <span><%=reporte.contadorComanda%></span>
    </div>
    <div>
        <span>Monto Total Comandas:</span>
        <span><%=monetarizar(reporte.totalNF)%></span>
    </div>
    <div>
        <span>Cantidad de Tickets:</span>
        <span><%=reporte.contadorCAE%></span>
    </div>
    <div>
        <span>Monto Total Tickets:</span>
        <span><%=monetarizar(reporte.totalCAE)%></span>
    </div>
    <div>
        <span>Cantidad Total:</span>
        <span><b><%=reporte.contadorComanda + reporte.contadorCAE%></b></span>
    </div>
    <div>
        <span>Monto Total:</span>
        <span><b><%=monetarizar(reporte.totalNF + reporte.totalCAE)%></b></span>
    </div>
    <hr>
    <h2>Medios de Pago</h2>
    <div>
        <span>Efectivo:</span>
        <span><%=monetarizar(reporte.totalEfectivo)%></span>
    </div>
    <div>
        <span>Débito:</span>
        <span><%=monetarizar(reporte.totalDebito)%></span>
    </div>
    <div>
        <span>Crédito:</span>
        <span><%=monetarizar(reporte.totalCredito)%></span>
    </div>
    <div>
        <span>Virtual:</span>
        <span><%=monetarizar(reporte.totalNB)%></span>
    </div>
    <hr>
    <h1>Gastos y Retiros</h1>
    <div>
        <span>Gastos:</span>
        <span><%= monetarizar(resumenGastos.gastos) %></span>
    </div>
    <div>
        <span>Retiros:</span>
        <span><%= monetarizar(resumenGastos.retiros) %></span>
    </div>
    <hr>
    <div>
        <span>Descargar: </span>
        <!-- <span>
            <form action="/panel/local/caja/reporte/pdf" method="post" class="formBoton">
                <input type="hidden" name="id" value="<%=registro.id%>">
                <input type="submit" value="PDF" class="pedidoEstadoBoton btnNaranja medium off">
            </form>
        </span> -->
        <span>
            <form action="/panel/local/caja/reporte/excel" method="post" class="formBoton">
                <input type="hidden" name="id" value="<%=registro.id%>">
                <input type="submit" value="Excel" class="pedidoEstadoBoton btnVerde medium">
            </form>
        </span>
        
        
    </div>
</div>
<div>
    <h1>Detalle de productos vendidos</h1>
    <table>
        <thead>
            <tr>
                <th>Cantidad</th>
                <th>Frac.</th>
                <th>Producto</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            <%reporte.detalleVentasCaja.forEach((item) => {
                let fraccionamiento = "Unidad";
                let producto;
                if(item[0] > 99){
                    producto = productos.find((prod) => prod.id == item[1]);
                    if(producto.fraccionamiento == "kilo"){
                        fraccionamiento = "kilo";
                        item[2] = item[2]/1000
                    }
                } else if(item[0] < 100){
                    producto = productosPersonalizados.find((prod) => prod.id == item[1]);
                }
                if(producto === undefined){
                    console.log(`Error al buscar producto en Reporte de Caja para codigo ${item[0]} / usuario: ${usuario}`)
                    return;
                }
                %>
                <tr>
                    <td class="tablaCeldaNumero"><%=item[2]%></td>
                    <td><%=fraccionamiento%></td>
                    <td><%=producto.nombre%></td>
                    <td class="importe"><%=monetarizar(item[3])%></td>
                </tr>
            <%})%>
            <tr>
                <td></td>
                <td></td>
                <td class="importe"><b>Total</b></td>
                <td class="importe"><b><%=monetarizar(reporte.totalNF + reporte.totalCAE)%></b></td>
            </tr>
        </tbody>
    </table>
</div>
</div>

<script>
    window.registro = <%- JSON.stringify(registro) %>
    window.gastos = <%- JSON.stringify(gastos) %>
    window.resumenGastos = <%- JSON.stringify(resumenGastos) %>
    window.fecha = <%- JSON.stringify(fecha) %>
    window.productos = <%- JSON.stringify(productos) %>
  </script>